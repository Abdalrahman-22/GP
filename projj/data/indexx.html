<!DOCTYPE html>
<html>

<head>
  <title>NodeMCU LED Control</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <style>
    /* Custom CSS for centering content */
    html, body {
      height: 100%;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-container {
      text-align: center;
      border-radius: 50%;
    }
    .btn {
      border-radius: 50%;
    }
    /* Custom CSS for the new div */
    .action-container {
      background-color: #f0f0f0; /* Set your desired background color */
      padding: 10px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
      position: relative;
      display: none; /* Initially hidden */
    }
    .hide-button {
      position: absolute;
      top: 5px;
      right: 5px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="btn-container">
      <h1 class="mt-5">NodeMCU LED Control</h1>
      <button id="myButton" onclick="toggle()" ontouchstart="startTimer()" ontouchend="endTimer()" onmousedown="startTimer()" onmouseup="endTimer()" class="btn btn-lg btn-primary mt-3">(LED_STATE)</button>
    </div>

    <div class="action-container" id="actionContainer">
      <span class="hide-button" onclick="toggleVisibility()">x</span>
      <label for='seconds' id="timerlabel">Enter seconds:</label>
      <input type='number' class='form-control' id='seconds' min='0' oninput="validity.valid||(value='');"> <!--the last funciton to prevent negative sign-->
      <button onclick="setTimer()" class='btn btn-warning mt-3'>Perform Action</button>
    </div>

  </div>

  <script>
    var clickTimer;

    function startTimer() {  // for long press on the button
      clickTimer = setTimeout(function () {
        toggleVisibility();
      }, 1000); // if i click for 1000 millies then it will call togglevisibility()
    }

    function endTimer() {  // for long press on the button
      clearTimeout(clickTimer);
    }

    function setTimer() {   // for put timer to toggle
      var secondsValue = document.getElementById('seconds').value;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/ledstate?seconds=' + encodeURIComponent(secondsValue), true);
      xhr.send();
    }

    function toggle() {
      document.getElementById('seconds').value = -555;// to toggle the led immediately
      setTimer();
      document.getElementById('seconds').value = ''; // Clear the value

    }

    setInterval(function () {   updateLEDState();  }, 300); // for update the button

    function updateLEDState() {

      var button = document.getElementById("myButton");

      fetch('/ledstate')
    .then(response => response.json())
    .then(data => {
      console.log('Received data:', data);

      if (data.state == "On") {
            button.innerHTML = "Off";
            button.classList.remove("btn-success");
            button.classList.add("btn-danger");
          } else if (data.state == "Off") {
            button.innerHTML = "On";
            button.classList.remove("btn-danger");
            button.classList.add("btn-success");
          }

          var timerlabel=document.getElementById("timerlabel");
          var timetotoggle=data.secondsToToggle;
          var nextstate=(data.state=="Off") ? "On" : "Off";
          if(timetotoggle==-1)
          {
            timerlabel.innerHTML="set a timer";
          }
          else
          {
           timerlabel.innerHTML="Led will be "+nextstate+" after "+ data.secondsToToggle+" seconds";

          }

    })
    .catch(error => {
      console.error('Error fetching data:', error);
    });
    }

    function toggleVisibility() {
      var container = document.getElementById("actionContainer");

      if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    }
  </script>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

</body>

</html>
